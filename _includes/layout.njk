<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ '/img/favicon/apple-touch-icon.png' | addHash }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{{ '/img/favicon/favicon-32x32.png' | addHash }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{{ '/img/favicon/favicon-16x16.png' | addHash }}"
    />
    <link rel="stylesheet" href="{{ '/styles.min.css' | addHash }}" />

    <title>{{ site.title }}</title>
  </head>
  <body>
    <header>
      <nav>
        <h1>
          <a href="/"> {{ site.title }} </a>
        </h1>
      </nav>
      <canvas id="mt-fuji"></canvas>
      {% if title %}
      <h1>{{ title }}</h1>
      <p>
        <date>{{ date | formatDate }}</date>
      </p>
      {% endif %}
    </header>
    <main>
      <section>
        {{ content | safe }}
      </section>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.0.0/quicklink.umd.js"></script>
    <script>
      window.addEventListener('load', () => {
        quicklink.listen();
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script>
      (function () {
        var canvas = document.getElementById('mt-fuji');
        if (!canvas || !window.THREE) return;

        var W = canvas.clientWidth, H = canvas.clientHeight;
        var SCALE = 0.5;
        var SEGS = 9;

        var renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: false });
        renderer.setSize(W * SCALE, H * SCALE, false);

        var scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a2744);
        scene.fog = new THREE.Fog(0x1a2744, 18, 32);

        var camera = new THREE.PerspectiveCamera(50, W / H, 0.1, 50);
        camera.position.set(0, 3, 12);
        camera.lookAt(0, 2, 0);

        scene.add(new THREE.AmbientLight(0x334477, 0.8));
        var sun = new THREE.DirectionalLight(0xffd0a0, 1.2);
        sun.position.set(5, 8, 3);
        scene.add(sun);

        var profile = [
          new THREE.Vector2(4.0, 0.0),
          new THREE.Vector2(3.5, 0.4),
          new THREE.Vector2(2.8, 1.1),
          new THREE.Vector2(2.0, 2.1),
          new THREE.Vector2(1.4, 3.1),
          new THREE.Vector2(0.9, 3.9),
          new THREE.Vector2(0.5, 4.5),
          new THREE.Vector2(0.0, 5.0)
        ];

        var fujiGroup = new THREE.Group();

        fujiGroup.add(new THREE.Mesh(
          new THREE.LatheGeometry(profile, SEGS),
          new THREE.MeshPhongMaterial({ color: 0x6b5a4a, flatShading: true, shininess: 5 })
        ));

        var snow = new THREE.Mesh(
          new THREE.ConeGeometry(0.9, 1.4, SEGS),
          new THREE.MeshPhongMaterial({ color: 0xe8eef4, flatShading: true, shininess: 15 })
        );
        snow.position.y = 4.7;
        fujiGroup.add(snow);

        fujiGroup.add(new THREE.Mesh(
          new THREE.CylinderGeometry(4.2, 4.8, 0.5, SEGS),
          new THREE.MeshPhongMaterial({ color: 0x2d4a2d, flatShading: true, shininess: 0 })
        ));

        scene.add(fujiGroup);

        var starPos = [];
        for (var i = 0; i < 250; i++) {
          starPos.push(
            (Math.random() - 0.5) * 50,
            Math.random() * 20 + 2,
            (Math.random() - 0.5) * 50 - 15
          );
        }
        var starsGeo = new THREE.BufferGeometry();
        starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.18 })));

        (function animate() {
          requestAnimationFrame(animate);
          fujiGroup.rotation.y += 0.006;
          renderer.render(scene, camera);
        })();

        window.addEventListener('resize', function () {
          var W = canvas.clientWidth, H = canvas.clientHeight;
          camera.aspect = W / H;
          camera.updateProjectionMatrix();
          renderer.setSize(W * SCALE, H * SCALE, false);
        });
      })();
    </script>
  </body>
</html>
